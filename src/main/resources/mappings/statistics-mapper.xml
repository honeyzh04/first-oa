<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.first.mapper.StatisticsMapper">
    <!--部门日报表-->
    <select id="findDeday"
            resultType="com.first.entity.StatisticsFormMap">
				SELECT a.id,a.name , ifnull(b.addw,0)
		addw,ifnull(b.adddh,0)
		adddh,ifnull(b.addwl,0) addwl,ifnull(b.addqt,0)
		addqt,ifnull(b.addg,0)
		addg,ifnull(b.addz,0) addz,ifnull(c.visit,0)
		vis,ifnull(d.deal,0)
		dea,ifnull(e.follow,0) follow,day(#{choiceday})
		days FROM

		(SELECT * FROM ogdepartment WHERE parentId in (12,13,14,15,4))
		as a left
		JOIN
		(SELECT
		c.deId,
		COUNT(if(c.source=1 and
		c.cusource=9,true,null)) adddh,
		COUNT(if(c.source=1 and c.cusource IN
		(0,7,8),true,null)) addqt,
		COUNT(if(c.source=1 and c.cusource IN
		(1,2,3,4,5,6),true,null)) addwl,
		COUNT(c.source=1 or null)addw,
		COUNT(c.source=2 or null) addg,
		COUNT(c.source=3 OR NULL) addz
		FROM
		(SELECT a.*, cudata.cusource FROM (SELECT  * FROM cu_add
		WHERE
		DATE_FORMAT(cu_add.addDate, '%Y%m%d' )=DATE_FORMAT(#{choiceday}, '%Y%m%d' )) as a LEFT JOIN
		cudata ON cudata.id =a.customerId) AS c GROUP BY c.deId)as b ON
		b.deId=a.id left JOIN

		(SELECT deId,COUNT(customerId or null) visit FROM cu_visit
		WHERE
		DATE_FORMAT(cu_visit.visitDate, '%Y%m%d' )=DATE_FORMAT(#{choiceday}, '%Y%m%d' )
	GROUP BY deId)	as c
		ON c.deId=a.id LEFT JOIN

(SELECT deId,COUNT(customerId or null) deal FROM cu_deal
		WHERE
		DATE_FORMAT(cu_deal.dealDate, '%Y%m%d' )=DATE_FORMAT(#{choiceday}, '%Y%m%d' )
	GROUP BY deId)
AS d ON
		d.deId=a.id LEFT JOIN

(SELECT deId,COUNT(customerId or null) follow FROM cu_follow
		WHERE
		DATE_FORMAT(cu_follow.CreateDate, '%Y%m%d' )=DATE_FORMAT(#{choiceday}, '%Y%m%d' )
	GROUP BY deId)as e ON e.deId=a.id

		ORDER BY
		a.parentId,a.id
	</select>
    <!-- 日报表统计 -->
    <select id="findSumDeday"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT
		"9999" as id,
		"合计" as name,
		day(#{choiceday}) days,
		COUNT(if(c.source=1 and
		c.cusource=9,true,null)) adddh,
		COUNT(if(c.source=1 and c.cusource IN
		(0,7,8),true,null)) addqt,
		COUNT(if(c.source=1 and c.cusource IN
		(1,2,3,4,5,6),true,null)) addwl,
		COUNT(c.source=1 or null)addw,
		COUNT(c.source=2 or null) addg,
		COUNT(c.source=3 OR NULL) addz,
		(SELECT
		COUNT(*) FROM cu_follow WHERE
		DATE_FORMAT(cu_follow.CreateDate,
		'%Y%m%d' )=DATE_FORMAT(#{choiceday},
		'%Y%m%d') ) follow,
		(SELECT
		COUNT(*) FROM cu_visit WHERE
		DATE_FORMAT(cu_visit.visitDate,
		'%Y%m%d' )=DATE_FORMAT(#{choiceday},
		'%Y%m%d'))vis ,
		(SELECT
		COUNT(*) FROM cu_deal WHERE
		DATE_FORMAT(cu_deal.dealDate,
		'%Y%m%d' )=DATE_FORMAT(#{choiceday},
		'%Y%m%d')
		) dea
		FROM
		(SELECT a.*, cudata.cusource FROM (SELECT cu_add.*
		FROM cu_add
		WHERE
		DATE_FORMAT(cu_add.addDate,
		'%Y%m%d'
		)=DATE_FORMAT(#{choiceday},
		'%Y%m%d')) as a LEFT JOIN
		cudata ON
		cudata.id
		=a.customerId) AS c
	</select>
	<!--部门周报表-->
    <select id="findDeweek"
            resultType="com.first.entity.StatisticsFormMap">
				SELECT a.id,a.name , ifnull(b.addw,0)
		addw,ifnull(b.adddh,0)
		adddh,ifnull(b.addwl,0) addwl,ifnull(b.addqt,0)
		addqt,ifnull(b.addg,0)
		addg,ifnull(b.addz,0) addz,ifnull(c.visit,0)
		vis,ifnull(d.deal,0)
		dea,ifnull(e.follow,0) follow
		FROM

		(SELECT * FROM ogdepartment WHERE parentId in (12,13,14,15,4))
		as a left
		JOIN
		(SELECT
		c.deId,
		COUNT(if(c.source=1 and
		c.cusource=9,true,null)) adddh,
		COUNT(if(c.source=1 and c.cusource IN
		(0,7,8),true,null)) addqt,
		COUNT(if(c.source=1 and c.cusource IN
		(1,2,3,4,5,6),true,null)) addwl,
		COUNT(c.source=1 or null)addw,
		COUNT(c.source=2 or null) addg,
		COUNT(c.source=3 OR NULL) addz
		FROM
		(SELECT a.*, cudata.cusource FROM (SELECT  * FROM cu_add
		WHERE
		cu_add.addDate  between
		#{departweeks} and #{departweeke}
		) as a LEFT JOIN
		cudata ON cudata.id =a.customerId) AS c GROUP BY c.deId)as b ON
		b.deId=a.id left JOIN

		(SELECT deId,COUNT(customerId or null) visit FROM cu_visit
		WHERE
		visitDate  between
		#{departweeks} and #{departweeke}
	GROUP BY deId)	as c
		ON c.deId=a.id LEFT JOIN

(SELECT deId,COUNT(customerId or null) deal FROM cu_deal
		WHERE
		dealDate  between
		#{departweeks} and #{departweeke}
	GROUP BY deId)
AS d ON
		d.deId=a.id LEFT JOIN

(SELECT deId,COUNT(customerId or null) follow FROM cu_follow
		WHERE
		CreateDate  between
		#{departweeks} and #{departweeke}
	GROUP BY deId)as e ON e.deId=a.id

		ORDER BY
		a.parentId,a.id
	</select>
    <!-- 周报表统计 -->
    <select id="findSumDeweek"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT
		"9999" as id,
		"合计" as name,
		COUNT(if(c.source=1 and
		c.cusource=9,true,null)) adddh,
		COUNT(if(c.source=1 and c.cusource IN
		(0,7,8),true,null)) addqt,
		COUNT(if(c.source=1 and c.cusource IN
		(1,2,3,4,5,6),true,null)) addwl,
		COUNT(c.source=1 or null)addw,
		COUNT(c.source=2 or null) addg,
		COUNT(c.source=3 OR NULL) addz,
		(SELECT
		COUNT(*) FROM cu_follow WHERE
		cu_follow.createDate between
		#{departweeks} and #{departweeke} ) follow,
		(SELECT
		COUNT(*)
		FROM cu_visit WHERE
		cu_visit.visitDate between
		#{departweeks} and #{departweeke})vis ,
		(SELECT
		COUNT(*) FROM
		cu_deal WHERE
		cu_deal.dealDate between
		#{departweeks} and #{departweeke}
		) dea
		FROM
		(SELECT a.*,
		cudata.cusource FROM (SELECT cu_add.*
		FROM cu_add WHERE
		cu_add.addDate
		between
		#{departweeks} and #{departweeke}) as a LEFT JOIN
		cudata ON
		cudata.id
		=a.customerId) AS c
	</select>
	<!--部门月报表-->
    <select id="findDemonth"
            resultType="com.first.entity.StatisticsFormMap">


				SELECT a.id,a.name , ifnull(b.addw,0)
		addw,ifnull(b.adddh,0)
		adddh,ifnull(b.addwl,0) addwl,ifnull(b.addqt,0)
		addqt,ifnull(b.addg,0)
		addg,ifnull(b.addz,0) addz,ifnull(c.visit,0)
		vis,ifnull(d.deal,0)
		dea,ifnull(e.follow,0) follow,MONTH(#{choicemonth}) months
		FROM

		(SELECT * FROM ogdepartment WHERE parentId in (12,13,14,15,4))
		as a left
		JOIN
		(SELECT
		c.deId,
		COUNT(if(c.source=1 and
		c.cusource=9,true,null)) adddh,
		COUNT(if(c.source=1 and c.cusource IN
		(0,7,8),true,null)) addqt,
		COUNT(if(c.source=1 and c.cusource IN
		(1,2,3,4,5,6),true,null)) addwl,
		COUNT(c.source=1 or null)addw,
		COUNT(c.source=2 or null) addg,
		COUNT(c.source=3 OR NULL) addz
		FROM
		(SELECT a.*, cudata.cusource FROM (SELECT  * FROM cu_add
		WHERE
		DATE_FORMAT(cu_add.addDate, '%Y%m' )=DATE_FORMAT(#{choicemonth}, '%Y%m' )) as a LEFT JOIN
		cudata ON cudata.id =a.customerId) AS c GROUP BY c.deId)as b ON
		b.deId=a.id left JOIN

		(SELECT deId,COUNT(customerId or null) visit FROM cu_visit
		WHERE
		DATE_FORMAT(cu_visit.visitDate, '%Y%m' )=DATE_FORMAT(#{choicemonth}, '%Y%m' )
	GROUP BY deId)	as c
		ON c.deId=a.id LEFT JOIN

(SELECT deId,COUNT(customerId or null) deal FROM cu_deal
		WHERE
		DATE_FORMAT(cu_deal.dealDate, '%Y%m' )=DATE_FORMAT(#{choicemonth}, '%Y%m' )
	GROUP BY deId)
AS d ON
		d.deId=a.id LEFT JOIN

(SELECT deId,COUNT(customerId or null) follow FROM cu_follow
		WHERE
		DATE_FORMAT(cu_follow.CreateDate, '%Y%m' )=DATE_FORMAT(#{choicemonth}, '%Y%m' )
	GROUP BY deId)as e ON e.deId=a.id

		ORDER BY
		a.parentId,a.id


	</select>
    <!-- 月报表统计 -->
    <select id="findSumDemonth"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT
		"9999" as id,
		"合计" as name,
		MONTH(#{choicemonth})
		months,
		COUNT(if(c.source=1 and
		c.cusource=9,true,null)) adddh,
		COUNT(if(c.source=1 and c.cusource IN
		(0,7,8),true,null)) addqt,
		COUNT(if(c.source=1 and c.cusource IN
		(1,2,3,4,5,6),true,null)) addwl,
		COUNT(c.source=1 or null)addw,
		COUNT(c.source=2 or null) addg,
		COUNT(c.source=3 OR NULL) addz,
		(SELECT
		COUNT(*) FROM cu_follow WHERE
		DATE_FORMAT(cu_follow.CreateDate,
		'%Y%m'
		)=DATE_FORMAT(#{choicemonth},
		'%Y%m') ) follow,
		(SELECT
		COUNT(*) FROM
		cu_visit WHERE
		DATE_FORMAT(cu_visit.visitDate,
		'%Y%m'
		)=DATE_FORMAT(#{choicemonth},
		'%Y%m'))vis ,
		(SELECT
		COUNT(*) FROM
		cu_deal WHERE
		DATE_FORMAT(cu_deal.dealDate,
		'%Y%m'
		)=DATE_FORMAT(#{choicemonth},
		'%Y%m')
		) dea
		FROM
		(SELECT a.*,
		cudata.cusource FROM (SELECT cu_add.* FROM
		cu_add
		WHERE
		DATE_FORMAT(cu_add.addDate,
		'%Y%m'
		)=DATE_FORMAT(#{choicemonth},
		'%Y%m')) as a LEFT JOIN
		cudata ON
		cudata.id
		=a.customerId) AS c

	</select>
	<!-- 个人月每天报表 -->
	<select id="findPedays"
			resultType="com.first.entity.StatisticsFormMap">
		SELECT
		a.id,
		a.userName,
		a.department,
		ifnull(c.adds, 0) adds,
		ifnull(d.follow, 0) follow,
		ifnull(b.visit, 0) visit,
		ifnull(b.projectName, "") projectName,
		a.days
		FROM
		(
		SELECT
		a.id,
		a.userName,
		a.department,
		b.days
		FROM
		oguser a,
		cu_day b
		WHERE
		b.days &lt;= DAY (NOW())
		AND a.id =  #{userId}
		) AS a
		LEFT JOIN (
		SELECT
		COUNT(customerId) visit,
		GROUP_CONCAT(projectId) projectName,
		DAY (visitDate) AS days
		FROM
		cu_visit
		WHERE
		DATE_FORMAT(visitDate, '%Y%m') = DATE_FORMAT(now(), '%Y%m')
		AND userId = #{userId}
		GROUP BY
		days
		) b ON a.days = b.days
		LEFT JOIN (
		SELECT
		COUNT(customerId) adds,
		DAY (addDate) AS days
		FROM
		cu_add
		WHERE
		DATE_FORMAT(addDate, '%Y%m') = DATE_FORMAT(now(), '%Y%m')
		AND userId =  #{userId}
		GROUP BY
		days
		) c ON a.days = c.days
		LEFT JOIN (
		SELECT
		COUNT(customerId) follow,
		DAY (CreateDate) AS days
		FROM
		cu_follow
		WHERE
		DATE_FORMAT(CreateDate, '%Y%m') = DATE_FORMAT(now(), '%Y%m')
		AND userId = #{userId}
		GROUP BY
		days
		) d ON a.days = d.days
	</select>
    <!-- 部门当月每天报表 -->
    <select id="findDedays"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT a.id,a.name , ifnull(b.addw,0)
		addw,ifnull(b.adddh,0) adddh,ifnull(b.addwl,0) addwl,ifnull(b.addqt,0)
		addqt,ifnull(b.addg,0) addg,ifnull(b.addz,0) addz,ifnull(c.vis,0)
		vis,ifnull(d.dea,0) dea,ifnull(e.follow,0) follow,
		a.days FROM

		(SELECT
		a.id ,a.`name` ,a.parentId,b.days FROM ogdepartment a
		,cu_day b WHERE
		b.days &lt;=day(NOW())and parentId in (12,13,14,15,4)) as
		a left JOIN

		(SELECT
		c.name,
		c.department,

		COUNT(if(c.source=1 and
		c.cusource=9,true,null)) adddh,
		COUNT(if(c.source=1 and c.cusource IN
		(0,7,8),true,null)) addqt,
		COUNT(if(c.source=1 and c.cusource IN
		(1,2,3,4,5,6),true,null)) addwl,
		COUNT(c.source=1 or null)addw,
		COUNT(c.source=2 or null) addg,
		COUNT(c.source=3 OR NULL) addz ,
		c.days
		FROM (SELECT a.*, cudata.cusource FROM
		(SELECT
		cu_add.*,day(cu_add.addDate) as days,oguser.department
		,ogdepartment.`name` from cu_add LEFT JOIN oguser ON
		cu_add.userId=oguser.id LEFT JOIN ogdepartment ON
		ogdepartment.id=oguser.department WHERE
		DATE_FORMAT(cu_add.addDate,
		'%Y%m' )=DATE_FORMAT(now(), '%Y%m')) as a LEFT JOIN
		cudata ON cudata.id
		=a.customerId) AS c GROUP BY c.name,c.days) as b ON
		b.department=a.id
		AND a.days=b.days left JOIN

		(SELECT
		d.name,
		d.department,
		d.days,
		COUNT(
		d.customerId or null) vis
		FROM
		(SELECT cu_visit.*,day(cu_visit.visitDate)
		as days,oguser.department
		,ogdepartment.`name`
		from cu_visit LEFT JOIN
		oguser ON cu_visit.userId=oguser.id LEFT JOIN
		ogdepartment ON
		ogdepartment.id=oguser.department
		WHERE
		DATE_FORMAT(cu_visit.visitDate,
		'%Y%m' )=DATE_FORMAT(now(), '%Y%m')
		) AS d GROUP BY d.name ,d.days ) as
		c ON c.department=a.id AND
		a.days=c.days LEFT JOIN

		(SELECT
		e.name,
		e.department,
		e.days ,
		COUNT( e.customerId or null) dea
		FROM
		((SELECT
		cu_deal.*,
		day(cu_deal.dealDate) as days,
		oguser.department ,
		ogdepartment.`name`
		from cu_deal LEFT JOIN oguser ON
		cu_deal.userId=oguser.id LEFT JOIN
		ogdepartment ON
		ogdepartment.id=oguser.department
		WHERE
		DATE_FORMAT(cu_deal.dealDate,
		'%Y%m' )=DATE_FORMAT(now(), '%Y%m')
		)) AS e GROUP BY e.name ,e.days) AS
		d ON d.department=a.id AND
		a.days=d.days LEFT JOIN

		(SELECT f.name,
		f.department,
		COUNT( f.customerId or null) follow ,
		f.days
		FROM
		(SELECT
		cu_follow.*,
		oguser.department ,
		day(cu_follow.CreateDate) as days,
		ogdepartment.`name`
		from cu_follow LEFT JOIN oguser ON
		cu_follow.userId=oguser.id LEFT JOIN
		ogdepartment ON
		ogdepartment.id=oguser.department
		WHERE
		DATE_FORMAT(cu_follow.CreateDate, '%Y%m' )=DATE_FORMAT(now(),'%Y%m'))
		AS f GROUP BY f.name,f.days) as e ON e.department=a.id AND
		a.days=e.days
		ORDER BY a.parentId,a.id ,a.days
	</select>
	<!-- 个人报表月排行榜 -->
    <select id="findRankPerAddMonth"
            resultType="com.first.entity.StatisticsFormMap">
			SELECT * FROM (SELECT a.userName ,a.name,ifnull(b.addw,0)
		addw FROM
		(SELECT
		oguser.id,oguser.userName,ogdepartment.name FROM
		oguser LEFT
		JOIN
		ogdepartment ON ogdepartment.id=oguser.department WHERE
		oguser.locked=1 and ogdepartment.parentId in (4,12,13,14,15)) as a LEFT
		JOIN

		(SELECT cu_add.userId, cu_add.userName,COUNT( customerId or null)
		addw FROM
		cu_add where cu_add.source=1 and DATE_FORMAT(addDate, '%Y%m'
		)=DATE_FORMAT(now(), '%Y%m' ) GROUP BY userId ) as b
		ON b.userId=a.id

		ORDER BY addw desc LIMIT 5) as a ORDER BY addw asc
	</select>
    <select id="findRankPerFollowMonth"
            resultType="com.first.entity.StatisticsFormMap">

		SELECT a.userName ,a.name,ifnull(b.follow,0)follow FROM
		(SELECT oguser.id,oguser.userName,ogdepartment.name FROM oguser LEFT
		JOIN ogdepartment ON ogdepartment.id=oguser.department WHERE
		oguser.locked=1 and ogdepartment.parentId in (12,13,14,15,4)) as a LEFT
		JOIN

		(SELECT cu_follow.userId, cu_follow.userName,COUNT( customerId or
		null) follow
		FROM cu_follow where DATE_FORMAT(CreateDate, '%Y%m'
		)=DATE_FORMAT(now(), '%Y%m' ) GROUP BY userId ) as b
		ON b.userId=a.id

		ORDER BY follow desc LIMIT 5
	</select>
    <select id="findRankPerVisMonth"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT * FROM (SELECT a.userName ,a.name,ifnull(b.vis,0)vis
		FROM
		(SELECT
		oguser.id,oguser.userName,ogdepartment.name FROM oguser
		LEFT JOIN
		ogdepartment ON ogdepartment.id=oguser.department WHERE
		oguser.locked=1 and ogdepartment.parentId in (4,12,13,14,15)) as a LEFT
		JOIN

		(SELECT cu_visit.userId, cu_visit.userName,COUNT( customerId or
		null) vis FROM
		cu_visit where DATE_FORMAT(visitDate, '%Y%m'
		)=DATE_FORMAT(now(),
		'%Y%m' ) GROUP BY userId ) as b
		ON b.userId=a.id

		ORDER BY vis desc LIMIT 5) as a ORDER BY vis asc
	</select>
    <select id="findRankPerDeaMonth"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT * FROM (SELECT a.userName ,a.name,ifnull(b.dea,0)dea
		FROM
		(SELECT
		oguser.id,oguser.userName,ogdepartment.name FROM oguser
		LEFT JOIN
		ogdepartment ON ogdepartment.id=oguser.department WHERE
		oguser.locked=1 and ogdepartment.parentId in (4,12,13,14,15)) as a LEFT
		JOIN

		(SELECT cu_deal.userId, cu_deal.userName,COUNT( customerId or null)
		dea FROM
		cu_deal where DATE_FORMAT(dealDate, '%Y%m' )=DATE_FORMAT(now(),
		'%Y%m'
		) GROUP BY userId ) as b
		ON b.userId=a.id

		ORDER BY dea desc LIMIT
		5) as a ORDER BY dea asc
	</select>
	<!-- 部门报表月排行榜 -->
    <select id="findRankDeAddMonth"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT a.id,a.name ,ifnull(b.addw,0) addw FROM
		(SELECT *
		FROM ogdepartment WHERE parentId in (12,13,14,15,4)) as a left JOIN
		(SELECT		c.deId,
		COUNT(c.source=1 or null)addw
		FROM (SELECT
		a.*, cudata.cusource FROM (SELECT  * FROM cu_add
		WHERE
		DATE_FORMAT(cu_add.addDate,
		'%Y%m' )=DATE_FORMAT(now(), '%Y%m')) as a LEFT JOIN
		cudata ON
		cudata.id =a.customerId) AS c GROUP BY c.deId) as b ON
		b.deId=a.id
		ORDER BY addw desc LIMIT 5
	</select>
    <select id="findRankDeFollowMonth"
            resultType="com.first.entity.StatisticsFormMap">

		SELECT a.id,a.name ,ifnull(e.follow,0) follow FROM
		(SELECT *
		FROM ogdepartment WHERE parentId in (12,13,14,15,4)) as a left JOIN

		(SELECT f.deId,COUNT( f.customerId or null) follow FROM
		(SELECT  * FROM cu_follow
		WHERE
		DATE_FORMAT(cu_follow.CreateDate,
		'%Y%m' )=DATE_FORMAT(now(), '%Y%m'))
		AS f GROUP BY f.deId) as e ON e.deId=a.id
		ORDER BY follow desc
		LIMIT 5
	</select>
    <select id="findRankDeVisMonth"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT a.id,a.name ,ifnull(c.vis,0) vis FROM
		(SELECT * FROM
		ogdepartment WHERE parentId in (12,13,14,15,4)) as a left JOIN
		(SELECT
		d.deId,
		COUNT( d.customerId or null) vis
		FROM
		(SELECT  * FROM cu_visit
		WHERE
		DATE_FORMAT(cu_visit.visitDate,
		'%Y%m' )=DATE_FORMAT(now(), '%Y%m')
		) AS d GROUP BY d.deId ) as c ON
		c.deId=a.id
		ORDER BY vis desc LIMIT 5
	</select>
    <select id="findRankDeDeaMonth"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT a.id,a.name ,ifnull(d.dea,0) dea FROM
		(SELECT * FROM
		ogdepartment WHERE parentId in (12,13,14,15,4)) as a left JOIN
		(SELECT
		e.deId,COUNT( e.customerId or null) dea FROM
		(SELECT  * FROM cu_deal
		WHERE
		DATE_FORMAT(cu_deal.dealDate,
		'%Y%m' )=DATE_FORMAT(now(), '%Y%m'))
		AS e GROUP BY e.deId ) AS d ON
		d.deId=a.id
		ORDER BY dea desc LIMIT 5
	</select>

    <!-- 部门个人日报表 -->
    <select id="findpeday"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT a.id,a.userName ,a.did,a.name,ifnull(b.addw,0)
		addw,ifnull(b.adddh,0) adddh,ifnull(b.addwl,0) addwl,ifnull(b.addqt,0)
		addqt,ifnull(b.addg,0) addg,ifnull(b.addz,0) addz,ifnull(e.follow,0)
		follow,ifnull(c.vis,0) vis,ifnull(d.dea,0) dea,day(#{choiceday}) days
		FROM
		(SELECT oguser.id,oguser.userName,ogdepartment.id as did
		,ogdepartment.name
		FROM oguser LEFT JOIN ogdepartment ON
		ogdepartment.id=oguser.department WHERE oguser.locked=1 and
		ogdepartment.parentId in (12,13,14,15,4)) as a LEFT JOIN

		(SELECT
		c.userId
		,
		c.userName ,
		COUNT(if(c.source=1 and c.cusource=9,true,null)) adddh,
		COUNT(if(c.source=1 and c.cusource IN (0,7,8),true,null)) addqt,
		COUNT(if(c.source=1 and c.cusource IN (1,2,3,4,5,6),true,null)) addwl,
		COUNT(c.source=1 or null)addw,
		COUNT(c.source=2 or null) addg,
		COUNT(c.source=3 OR NULL) addz
		FROM (SELECT b.*, cudata.cusource FROM
		(SELECT cu_add.* FROM cu_add where DATE_FORMAT(addDate, '%Y%m%d'
		)=DATE_FORMAT(#{choiceday}, '%Y%m%d' ) ) as b LEFT JOIN
		cudata ON
		cudata.id =b.customerId) AS c GROUP BY c.userId ) as b
		ON b.userId=a.id
		left JOIN

		(SELECT
		b.userId ,
		b.userName,
		COUNT( b.customerId or null) vis
		FROM(SELECT cu_visit.* FROM cu_visit where DATE_FORMAT(visitDate,
		'%Y%m%d'
		)=DATE_FORMAT(#{choiceday}, '%Y%m%d' ) ) as b GROUP BY
		b.userId) as c
		ON c.userId=a.id left JOIN

		(SELECT
		b.userId ,
		b.userName,
		COUNT( b.customerId or null) dea
		FROM(SELECT cu_deal.* FROM cu_deal where
		DATE_FORMAT(dealDate, '%Y%m%d'
		)=DATE_FORMAT(#{choiceday}, '%Y%m%d' ) )
		as b GROUP BY b.userId) as d
		ON d.userId=a.id left JOIN

		(SELECT
		b.userId
		,
		b.userName,
		COUNT( b.customerId or null) follow
		FROM(SELECT cu_follow.*
		FROM cu_follow where DATE_FORMAT(CreateDate, '%Y%m%d'
		)=DATE_FORMAT(#{choiceday}, '%Y%m%d' ) ) as b GROUP BY b.userId) as e
		ON e.userId=a.id
		WHERE a.did=#{deId}

	</select>
    <!-- 部门个人周报表 -->
    <select id="findpeweek"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT a.id,a.userName ,a.did,a.name,ifnull(b.addw,0)
		addw,ifnull(b.adddh,0)
		adddh,ifnull(b.addwl,0) addwl,ifnull(b.addqt,0)
		addqt,ifnull(b.addg,0)
		addg,ifnull(b.addz,0) addz,ifnull(e.follow,0)
		follow,ifnull(c.vis,0)
		vis,ifnull(d.dea,0) dea
		FROM
		(SELECT
		oguser.id,oguser.userName,ogdepartment.id as did
		,ogdepartment.name
		FROM oguser LEFT JOIN ogdepartment ON
		ogdepartment.id=oguser.department WHERE oguser.locked=1 and
		ogdepartment.parentId in (12,13,14,15,4)) as a LEFT JOIN

		(SELECT
		c.userId
		,
		c.userName ,
		COUNT(if(c.source=1 and c.cusource=9,true,null)) adddh,
		COUNT(if(c.source=1 and c.cusource IN (0,7,8),true,null)) addqt,
		COUNT(if(c.source=1 and c.cusource IN (1,2,3,4,5,6),true,null)) addwl,
		COUNT(c.source=1 or null)addw,
		COUNT(c.source=2 or null) addg,
		COUNT(c.source=3 OR NULL) addz
		FROM (SELECT b.*, cudata.cusource FROM
		(SELECT cu_add.* FROM cu_add where cu_add.addDate between
		#{departweeks} and #{departweeke}) as b LEFT JOIN
		cudata ON
		cudata.id =b.customerId)
		AS c GROUP BY c.userId ) as b
		ON b.userId=a.id
		left JOIN


		(SELECT
		b.userId
		,
		b.userName,
		COUNT( b.customerId or null) vis
		FROM(SELECT cu_visit.* FROM
		cu_visit where cu_visit.visitDate between
		#{departweeks} and
		#{departweeke}) as b GROUP BY
		b.userId) as c
		ON c.userId=a.id left JOIN

		(SELECT
		b.userId ,
		b.userName,
		COUNT( b.customerId or null) dea
		FROM(SELECT cu_deal.* FROM cu_deal where
		cu_deal.dealDate between
		#{departweeks} and #{departweeke} )
		as b GROUP BY b.userId) as
		d
		ON d.userId=a.id left JOIN

		(SELECT
		b.userId
		,
		b.userName,
		COUNT(
		b.customerId or null) follow
		FROM(SELECT cu_follow.*
		FROM cu_follow where
		cu_follow.createDate between
		#{departweeks} and #{departweeke} ) as b GROUP BY b.userId) as e
		ON e.userId=a.id
		WHERE a.did=#{deId}
	</select>
    <!-- 部门个人月报表 -->
    <select id="findpemonth"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT a.id,a.userName ,a.did,a.name,ifnull(b.addw,0)
		addw,ifnull(b.adddh,0) adddh,ifnull(b.addwl,0) addwl,ifnull(b.addqt,0)
		addqt,ifnull(b.addg,0) addg,ifnull(b.addz,0) addz,ifnull(e.follow,0)
		follow,ifnull(c.vis,0) vis,ifnull(d.dea,0)
		dea,month(#{choicemonth})months
		FROM
		(SELECT
		oguser.id,oguser.userName,ogdepartment.id as did
		,ogdepartment.name
		FROM oguser LEFT JOIN ogdepartment ON
		ogdepartment.id=oguser.department WHERE oguser.locked=1 and
		ogdepartment.parentId in (12,13,14,15,4)) as a LEFT JOIN

		(SELECT
		c.userId
		,
		c.userName ,
		COUNT(if(c.source=1 and c.cusource=9,true,null)) adddh,
		COUNT(if(c.source=1 and c.cusource IN (0,7,8),true,null)) addqt,
		COUNT(if(c.source=1 and c.cusource IN (1,2,3,4,5,6),true,null)) addwl,
		COUNT(c.source=1 or null)addw,
		COUNT(c.source=2 or null) addg,
		COUNT(c.source=3 OR NULL) addz
		FROM (SELECT b.*, cudata.cusource FROM
		(SELECT cu_add.* FROM cu_add where DATE_FORMAT(addDate, '%Y%m'
		)=DATE_FORMAT(#{choicemonth}, '%Y%m' ) ) as b LEFT JOIN
		cudata ON
		cudata.id =b.customerId) AS c GROUP BY c.userId ) as b
		ON b.userId=a.id
		left JOIN

		(SELECT
		b.userId ,
		b.userName,
		COUNT( b.customerId or null) vis
		FROM(SELECT cu_visit.* FROM cu_visit where DATE_FORMAT(visitDate,
		'%Y%m'
		)=DATE_FORMAT(#{choicemonth}, '%Y%m' ) ) as b GROUP BY
		b.userId) as c
		ON c.userId=a.id left JOIN

		(SELECT
		b.userId ,
		b.userName,
		COUNT(
		b.customerId or null) dea
		FROM(SELECT cu_deal.* FROM cu_deal where
		DATE_FORMAT(dealDate, '%Y%m'
		)=DATE_FORMAT(#{choicemonth}, '%Y%m' ) )
		as b GROUP BY b.userId) as d
		ON d.userId=a.id left JOIN

		(SELECT
		b.userId
		,
		b.userName,
		COUNT( b.customerId or null) follow
		FROM(SELECT cu_follow.*
		FROM cu_follow where DATE_FORMAT(CreateDate, '%Y%m'
		)=DATE_FORMAT(#{choicemonth}, '%Y%m' ) ) as b GROUP BY b.userId) as e
		ON e.userId=a.id
		WHERE a.did=#{deId}

	</select>
    <!-- 网络日报表 -->
    <select id="findSumInday"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT * FROM

		(SELECT
		"9999" as id,
		"合计" as name,
		day(#{choiceday}) days,

		COUNT(if(c.source=1 and c.cusource IN
		(1,2,3,4,5,6),true,null)) addwl,
		COUNT(if(c.source=1 and c.cusource =1,true,null)) addwlad,
		COUNT(if(c.source=1 and c.cusource =2,true,null)) addwl5d,
		COUNT(if(c.source=1 and c.cusource =3,true,null)) addwlfd,
		COUNT(if(c.source=1 and c.cusource =4,true,null)) addwlag,
		COUNT(if(c.source=1 and c.cusource =5,true,null)) addwl5g,
		COUNT(if(c.source=1 and c.cusource =6,true,null)) addwlfg


		FROM
		(SELECT a.*, cudata.cusource
		FROM (SELECT cu_add.*
		FROM cu_add
		WHERE
		DATE_FORMAT(cu_add.addDate,
		'%Y%m%d'
		)=DATE_FORMAT(#{choiceday},
		'%Y%m%d')) as a LEFT JOIN
		cudata ON
		cudata.id
		=a.customerId) AS c) as a,
		(SELECT

		COUNT(if(c.cusource IN (1,2,3,4,5,6),true,null)) viswl,
		COUNT(if( c.cusource =1,true,null)) viswlad,
		COUNT(if(c.cusource =2,true,null)) viswl5d,
		COUNT(if( c.cusource =3,true,null)) viswlfd,
		COUNT(if( c.cusource =4,true,null)) viswlag,
		COUNT(if(c.cusource =5,true,null)) viswl5g,
		COUNT(if(c.cusource =6,true,null)) viswlfg
		FROM
		(SELECT a.*, cudata.cusource FROM (SELECT cu_visit.*
		FROM cu_visit
		WHERE
		DATE_FORMAT(cu_visit.visitDate,
		'%Y%m%d'
		)=DATE_FORMAT(#{choiceday},
		'%Y%m%d')) as a LEFT JOIN
		cudata ON
		cudata.id
		=a.customerId) as c) as v,

		(SELECT


		COUNT(if(c.cusource IN
		(1,2,3,4,5,6),true,null)) deawl,
		COUNT(if(c.cusource =1,true,null)) deawlad,
		COUNT(if(c.cusource =2,true,null)) deawl5d,
		COUNT(if(c.cusource =3,true,null)) deawlfd,
		COUNT(if(c.cusource =4,true,null)) deawlag,
		COUNT(if(c.cusource =5,true,null)) deawl5g,
		COUNT(if(c.cusource =6,true,null)) deawlfg


		FROM
		(SELECT a.*, cudata.cusource FROM (SELECT
		cu_deal.*
		FROM cu_deal
		WHERE
		DATE_FORMAT(cu_deal.dealDate,
		'%Y%m%d'
		)=DATE_FORMAT(#{choiceday},
		'%Y%m%d')) as a LEFT JOIN
		cudata ON
		cudata.id
		=a.customerId) AS c) as d


	</select>
    <!-- 网络周报表 -->
    <select id="findSumInweek"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT * FROM

		(SELECT
		"9999" as id,
		"合计" as name,
		

		COUNT(if(c.source=1 and c.cusource IN
		(1,2,3,4,5,6),true,null)) addwl,
		COUNT(if(c.source=1 and c.cusource =1,true,null)) addwlad,
		COUNT(if(c.source=1 and c.cusource =2,true,null)) addwl5d,
		COUNT(if(c.source=1 and c.cusource =3,true,null)) addwlfd,
		COUNT(if(c.source=1 and c.cusource =4,true,null)) addwlag,
		COUNT(if(c.source=1 and c.cusource =5,true,null)) addwl5g,
		COUNT(if(c.source=1 and c.cusource =6,true,null)) addwlfg


		FROM
		(SELECT a.*, cudata.cusource
		FROM (SELECT cu_add.*
		FROM cu_add
		WHERE
		cu_add.addDate
		between
		#{departweeks} and #{departweeke}) as a LEFT JOIN
		cudata ON
		cudata.id
		=a.customerId) AS c) as a,
		(SELECT

		COUNT(if(c.cusource IN (1,2,3,4,5,6),true,null)) viswl,
		COUNT(if( c.cusource =1,true,null)) viswlad,
		COUNT(if(c.cusource =2,true,null)) viswl5d,
		COUNT(if( c.cusource =3,true,null)) viswlfd,
		COUNT(if( c.cusource =4,true,null)) viswlag,
		COUNT(if(c.cusource =5,true,null)) viswl5g,
		COUNT(if(c.cusource =6,true,null)) viswlfg
		FROM
		(SELECT a.*, cudata.cusource FROM (SELECT cu_visit.*
		FROM cu_visit
		WHERE
		cu_visit.visitDate
		between
		#{departweeks} and #{departweeke}) as a LEFT JOIN
		cudata ON
		cudata.id
		=a.customerId) as c) as v,

		(SELECT


		COUNT(if(c.cusource IN
		(1,2,3,4,5,6),true,null)) deawl,
		COUNT(if(c.cusource =1,true,null)) deawlad,
		COUNT(if(c.cusource =2,true,null)) deawl5d,
		COUNT(if(c.cusource =3,true,null)) deawlfd,
		COUNT(if(c.cusource =4,true,null)) deawlag,
		COUNT(if(c.cusource =5,true,null)) deawl5g,
		COUNT(if(c.cusource =6,true,null)) deawlfg


		FROM
		(SELECT a.*, cudata.cusource FROM (SELECT
		cu_deal.*
		FROM cu_deal
		WHERE
		cu_deal.dealDate
		between
		#{departweeks} and #{departweeke}) as a LEFT JOIN
		cudata ON
		cudata.id
		=a.customerId) AS c) as d


	</select>
    <!-- 网络月报表 -->
    <select id="findSumInmonth"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT * FROM

		(SELECT
		"9999" as id,
		"合计" as name,
		month(#{choicemonth}) months,

		COUNT(if(c.source=1 and c.cusource IN
		(1,2,3,4,5,6),true,null)) addwl,
		COUNT(if(c.source=1 and c.cusource =1,true,null)) addwlad,
		COUNT(if(c.source=1 and c.cusource =2,true,null)) addwl5d,
		COUNT(if(c.source=1 and c.cusource =3,true,null)) addwlfd,
		COUNT(if(c.source=1 and c.cusource =4,true,null)) addwlag,
		COUNT(if(c.source=1 and c.cusource =5,true,null)) addwl5g,
		COUNT(if(c.source=1 and c.cusource =6,true,null)) addwlfg


		FROM
		(SELECT a.*, cudata.cusource
		FROM (SELECT cu_add.*
		FROM cu_add
		WHERE
		DATE_FORMAT(cu_add.addDate,
		'%Y%m'
		)=DATE_FORMAT(#{choicemonth},
		'%Y%m')) as a LEFT JOIN
		cudata ON
		cudata.id
		=a.customerId) AS c) as a,
		(SELECT

		COUNT(if(c.cusource IN (1,2,3,4,5,6),true,null)) viswl,
		COUNT(if( c.cusource =1,true,null)) viswlad,
		COUNT(if(c.cusource =2,true,null)) viswl5d,
		COUNT(if( c.cusource =3,true,null)) viswlfd,
		COUNT(if( c.cusource =4,true,null)) viswlag,
		COUNT(if(c.cusource =5,true,null)) viswl5g,
		COUNT(if(c.cusource =6,true,null)) viswlfg
		FROM
		(SELECT a.*, cudata.cusource FROM (SELECT cu_visit.*
		FROM cu_visit
		WHERE
		DATE_FORMAT(cu_visit.visitDate,
		'%Y%m'
		)=DATE_FORMAT(#{choicemonth},
		'%Y%m')) as a LEFT JOIN
		cudata ON
		cudata.id
		=a.customerId) as c) as v,

		(SELECT


		COUNT(if(c.cusource IN
		(1,2,3,4,5,6),true,null)) deawl,
		COUNT(if(c.cusource =1,true,null)) deawlad,
		COUNT(if(c.cusource =2,true,null)) deawl5d,
		COUNT(if(c.cusource =3,true,null)) deawlfd,
		COUNT(if(c.cusource =4,true,null)) deawlag,
		COUNT(if(c.cusource =5,true,null)) deawl5g,
		COUNT(if(c.cusource =6,true,null)) deawlfg


		FROM
		(SELECT a.*, cudata.cusource FROM (SELECT
		cu_deal.*
		FROM cu_deal
		WHERE
		DATE_FORMAT(cu_deal.dealDate,
		'%Y%m'
		)=DATE_FORMAT(#{choicemonth},
		'%Y%m')) as a LEFT JOIN
		cudata ON
		cudata.id
		=a.customerId) AS c) as d


	</select>


    <!-- 竞价报表 -->
    <select id="findByExtension"
            resultType="com.first.entity.StatisticsFormMap">
        SELECT
        id,
        baiduss_price,
        baiduss_click,
        baiduxxl_price,
        baiduxxl_click,
        sougou_price,
        sougou_click,
        shenma_price,
        shenma_click,
        ifnull(convert((baiduss_price+baiduxxl_price+sougou_price+shenma_price)/adds,decimal(10,2)),0) as cost,
        ifnull(convert(adds/(baiduss_click+baiduxxl_click+sougou_click+shenma_click),decimal(10,4)),0) as
        add_conversion,
        ifnull(convert(dea/(baiduss_click+baiduxxl_click+sougou_click+shenma_click),decimal(10,4)),0) as dea_conversion,
        createDate,
        ifnull(b.dea, 0) dea,
        ifnull(b.price, 0) price,
        ifnull(b.commission, 0) commission,
        ifnull(b.projectName, 0) projectName,
        ifnull(c.vis, 0) vis,
        ifnull(d.adds, 0) adds
        FROM
        cuextension AS a
        LEFT JOIN (
        SELECT
        COUNT(a.customerId) AS dea,
        SUM(a.price) AS price,
        SUM(a.commission) AS commission,
        GROUP_CONCAT(a.projectId SEPARATOR ',') projectName,
        a.dealDate
        FROM
        (
        SELECT
        cu_deal.customerId,
        cu_deal.price,
        cu_deal.commission,
        cu_deal.projectId,
        cudata.telephone,
        cu_deal.dealDate
        FROM
        cu_deal
        INNER JOIN cudata ON cu_deal.customerId = cudata.id
        WHERE
        cudata.cusource IN (3, 6)
        GROUP BY
        DATE_FORMAT(cu_deal.dealDate, '%Y%m'),
        cudata.telephone
        ) AS a
        GROUP BY
        DATE_FORMAT(a.dealDate, '%Y%m%d')
        ) AS b ON DATE_FORMAT(a.createDate, '%Y%m%d') = DATE_FORMAT(b.dealDate, '%Y%m%d')
        LEFT JOIN (
        SELECT
        COUNT(b.customerId) AS vis,
        b.visitDate
        FROM
        (
        SELECT
        cu_visit.customerId,
        cudata.telephone,
        cu_visit.visitDate
        FROM
        cu_visit
        INNER JOIN cudata ON cu_visit.customerId = cudata.id
        WHERE
        cudata.cusource IN (3, 6)
        ) AS b
        GROUP BY
        DATE_FORMAT(b.visitDate, '%Y%m%d')
        ) AS c ON DATE_FORMAT(a.createDate, '%Y%m%d') = DATE_FORMAT(c.visitDate, '%Y%m%d')
        LEFT JOIN (
        SELECT
        COUNT(b.customerId) AS adds,
        b.createDate AS addcreateDate
        FROM
        (
        SELECT
        *
        FROM
        cuffxsource
        GROUP BY
        telephone
        ) AS b
        GROUP BY
        DATE_FORMAT(createDate, '%Y%m%d')
        ) AS d ON DATE_FORMAT(a.createDate, '%Y%m%d') = DATE_FORMAT(d.addcreateDate, '%Y%m%d')
        WHERE
        1=1
        <if test="monthDate != null and  monthDate != '' ">
            and DATE_FORMAT(createDate,'%Y%m'
            )=DATE_FORMAT(#{monthDate},'%Y%m')
        </if>
        ORDER BY
        createDate DESC


    </select>
    <!-- 查看当日竞价新增数据 -->
    <select id="findAddOther"
            resultType="java.util.HashMap">
		SELECT
	COUNT(*) AS alls,
	COUNT(ffxsource = 1 OR NULL) AS bdsq,
	COUNT(ffxsource = 2 OR NULL) AS batg,
	COUNT(ffxsource = 3 OR NULL) AS ffxdh,
	COUNT(ffxsource = 4 OR NULL) AS ffxwl,
	COUNT(ffxsource = 5 OR NULL) AS xxl,
	COUNT(ffxsource = 6 OR NULL) AS sm
FROM
	cuffxsource
WHERE
	DATE_FORMAT(createDate, '%Y%m%d') =DATE_FORMAT(#{createDate},'%Y%m%d')

	</select>
    <!-- 查看当日竞价到访数据 -->
    <select id="findVis"
            resultType="Integer">
			SELECT COUNT(a.customerId) as vis FROM (SELECT
	cu_visit.customerId
FROM
	cu_visit inner join cudata on cu_visit.customerId=cudata.id
WHERE
	DATE_FORMAT(cu_visit.visitDate, '%Y%m%d') =DATE_FORMAT(#{createDate},'%Y%m%d')
 GROUP BY cudata.telephone) as a

	</select>
    <!-- 查看当日成交数据 -->
    <select id="findDea"
            resultType="java.util.HashMap">
			SELECT COUNT(a.customerId)as dea  ,ifnull(SUM(a.price),0) as price,ifnull(SUM(a.commission),0) as commission ,ifnull(GROUP_CONCAT(a.projectId SEPARATOR ','),0) projectName FROM (SELECT
	cu_deal.customerId,cu_deal.price,cu_deal.commission,cu_deal.projectId
FROM
	cu_deal inner join cudata on cu_deal.customerId=cudata.id
WHERE
	DATE_FORMAT(cu_deal.dealDate, '%Y%m%d') =DATE_FORMAT(#{createDate},'%Y%m%d') GROUP BY cudata.telephone) as a

	</select>
    <!--添加竞价报表-->
    <insert id="addEntity">
		INSERT INTO
		cuextension
		VALUES
		(
		null,
		null,
		null,
		#{baiduss_price},
		#{baiduss_click},
		#{baiduxxl_price},
		#{baiduxxl_click},
		#{sougou_price},
		#{sougou_click},
		#{shenma_price},
		#{shenma_click},
		#{createDate}

		)
	</insert>
    <!--查看竞价来源  -->
    <select id="findSource"
            resultType="java.util.HashMap">
			SELECT
	COUNT(ffxsource = 1 OR NULL) baidusq,
	COUNT(ffxsource = 2 OR NULL) baidudh,
	COUNT(ffxsource = 3 OR NULL) ffxdh,
	COUNT(ffxsource = 4 OR NULL) ffxwl,
	COUNT(ffxsource = 5 OR NULL) xxl,
	COUNT(ffxsource = 6 OR NULL) sgsm,
	COUNT(ffxsource = 7 OR NULL) lxb,
	COUNT(ffxsource = 8 OR NULL) gzh,
	COUNT(ffxsource =9 OR NULL) qttj
FROM (SELECT * FROM ( SELECT
 *
FROM
	cuffxsource
WHERE 1=1
	GROUP BY telephone) as a where DATE_FORMAT(createDate, '%Y%m%d') = DATE_FORMAT(#{createDate}, '%Y%m%d') ) as a
	</select>
    <!--查看竞价周报表   -->

    <select id="findWeekExtension"
            resultType="com.first.entity.StatisticsFormMap">
		SELECT
	*
FROM
	cuwextension
WHERE
	DATE_FORMAT(start_date, '%Y%m%d') = DATE_FORMAT(#{screateDate}, '%Y%m%d')
AND DATE_FORMAT(end_date, '%Y%m%d') = DATE_FORMAT(#{ecreateDate}, '%Y%m%d')

	</select>
    <!--查看周报表和   -->
    <select id="findWeekSum" resultType="com.first.entity.StatisticsFormMap">
    SELECT
	"9999" AS id,
	"合计" AS platform,
	'' AS channel,
	'' AS ways,
	SUM(consume) AS consume,
	SUM(keyword) AS keyword,
	SUM(shows) AS shows,
	SUM(click) AS click,
	SUM(ip_click) AS ip_click,
	SUM(pv_click) AS pv_click,
	SUM(uv_click) AS uv_click,
	CONVERT (
		SUM(click) / SUM(click),
		DECIMAL (10, 4)
	) AS click_rate,
	'' AS avetime,
	'' AS bounce_rate,
	'' AS aveprice,
	SUM(telephone) AS telephone,
	SUM(eftelephone) AS eftelephone,
	SUM(weiliao) AS weiliao,
	SUM(efweiliao) AS efweiliao,
	SUM(shangqiao) AS shangqiao,
	SUM(efshangqiao) AS efshangqiao,
	SUM(message) AS message,
	CONVERT (
		SUM(consume) / (
			SUM(telephone) + SUM(weiliao) + SUM(shangqiao) + SUM(message)
		),
		DECIMAL (10, 2)
	) AS dialogue_cost,
	CONVERT (
		SUM(consume) / (
			SUM(eftelephone) + SUM(efweiliao) + SUM(efshangqiao) + SUM(message)
		),
		DECIMAL (10, 2)
	) AS efdialogue_cost,
	'' AS dialogue_time
    FROM
    cuwextension
    WHERE
    DATE_FORMAT(start_date, '%Y%m%d') = DATE_FORMAT(#{screateDate}, '%Y%m%d')
    AND DATE_FORMAT(end_date, '%Y%m%d') = DATE_FORMAT(#{ecreateDate}, '%Y%m%d')
    </select>
    <!--查看房发现带访周报表-->
    <select id="findWeekVisit" resultType="com.first.entity.StatisticsFormMap">
	SELECT
	count(a.userId) AS visit,
	department
FROM
	(
		SELECT
			cu_visit.customerId,
			cu_visit.userId
		FROM
			cu_visit
		LEFT JOIN cudata ON cu_visit.customerId = cudata.id
		WHERE
			visitDate BETWEEN #{screateDate}
		AND #{ecreateDate}
		AND cusource IN (3, 6)
	) AS a
RIGHT JOIN oguser ON a.userId = oguser.id
WHERE
	department IN (16, 18, 20, 21, 24, 26, 28)
GROUP BY
	oguser.department
	</select>
    <!--查看房发现成交周报表-->
    <select id="findWeekDeal" resultType="com.first.entity.StatisticsFormMap">
		SELECT
	count(a.userId) AS dea,
	department
FROM
	(
		SELECT
			cu_deal.customerId,
			cu_deal.userId
		FROM
			cu_deal
		LEFT JOIN cudata ON cu_deal.customerId = cudata.id
		WHERE
			dealDate BETWEEN #{screateDate}
		AND #{ecreateDate}
		AND cusource IN (3, 6)
	) AS a
			RIGHT JOIN oguser ON a.userId = oguser.id
			WHERE
	department IN (16, 18, 20, 21, 24, 26, 28)
		GROUP BY
	oguser.department
	</select>
    <!--查看房发现退单周报表-->
    <select id="findWeekRefund" resultType="com.first.entity.StatisticsFormMap">
		SELECT
	IFNULL(SUM(commission),0) AS commission
FROM
	(
		SELECT
			commission
		FROM
			cu_deal
		LEFT JOIN cudata ON cu_deal.customerId = cudata.id
		WHERE
			cudata.state = 5
		AND cusource IN (3, 6)
		AND cu_deal.dealDate BETWEEN #{screateDate}
		AND #{ecreateDate}
		GROUP BY
			telephone
	) AS a
	</select>
    <!--查看房发现新增周报表-->
    <select id="findWeekAdds" resultType="com.first.entity.StatisticsFormMap">
		SELECT
	SUM(a.adds + b.addshare) adds,
	a.department
FROM
	(
		SELECT
			count(a.userId) AS adds,
			department
		FROM
			(
				SELECT
					a.customerId,
					a.userId
				FROM
					(
						SELECT
							cu_add.customerId,
							cu_add.userId
						FROM
							cu_add
						WHERE
							cu_add.addDate BETWEEN #{screateDate}
		AND #{ecreateDate}
						AND source = 1
					) AS a
				LEFT JOIN cudata ON a.customerId = cudata.id
				WHERE
					cusource IN (3, 6)
			) AS a
		RIGHT JOIN oguser ON a.userId = oguser.id
		WHERE
			department IN (16, 18, 20, 21, 24, 26,28)
		GROUP BY
			oguser.department
	) a
LEFT JOIN (
	SELECT
		count(a.userId) AS addshare,
		department
	FROM
		(
			SELECT
				culshare.userId
			FROM
				culshare
			LEFT JOIN cudata ON culshare.customerId = cudata.id
			WHERE
				culshare.createDate BETWEEN #{screateDate}
		AND #{ecreateDate}
			AND cudata.cusource IN (3, 6)
			AND cudata.department = 28
			AND culshare.userId NOT IN (
				SELECT
					oguser.id
				FROM
					oguser
				WHERE
					department = 28
			)
			GROUP BY
				customerId
		) AS a
	RIGHT JOIN oguser ON a.userId = oguser.id
	WHERE
		department IN (16, 18, 20, 21, 24, 26,28)
	GROUP BY
		oguser.department
) AS b ON a.department = b.department
GROUP BY
	a.department
	</select>
    <!--查看房发现去重周报表-->
    <select id="findWeekFilter" resultType="com.first.entity.StatisticsFormMap">
		SELECT
	IFNULL(filter_add, 0) filter_add,
 	IFNULL(filter_visit, 0) filter_visit,
 	IFNULL(filter_deal, 0) filter_deal,
 	IFNULL(commission, 0) commission
FROM
	(
		SELECT
			"9999" AS id,
			COUNT(a.customerId) AS filter_add
		FROM
			(
				SELECT
					customerId
				FROM
					cu_add
				LEFT JOIN cudata ON cu_add.customerId = cudata.id
				WHERE
					source = 1
				AND cusource IN (3, 6)
				AND cu_add.addDate BETWEEN #{screateDate}
		AND #{ecreateDate}
				GROUP BY
					telephone
			) a
	) c
LEFT JOIN (
	SELECT
		"9999" AS id,
		COUNT(a.customerId) AS filter_visit
	FROM
		(
			SELECT
				customerId
			FROM
				cu_visit
			LEFT JOIN cudata ON cu_visit.customerId = cudata.id
			WHERE
				cusource IN (3, 6)
			AND cu_visit.visitDate BETWEEN #{screateDate}
		AND #{ecreateDate}
			GROUP BY
				telephone
		) a
) e ON c.id = e.id
LEFT JOIN (
	SELECT
		"9999" AS id,
		COUNT(a.customerId) AS filter_deal,
		SUM(a.commission) AS commission
	FROM
		(
			SELECT
				customerId,
				commission
			FROM
				cu_deal
			LEFT JOIN cudata ON cu_deal.customerId = cudata.id
			WHERE
				cusource IN (3, 6)
			AND cu_deal.dealDate BETWEEN #{screateDate}
		AND #{ecreateDate}
			GROUP BY
				telephone
		) a
) f ON c.id = f.id

	</select>
    <!--添加竞价周报表-->
    <insert id="addWeekReport">
		INSERT INTO
		cuwextension
		VALUES
		(
		null,
		#{platform},
		#{channel},
		#{ways},
		#{consume},
		#{keyword},
		#{shows},
		#{click},
		#{ip_click},
		#{pv_click},
		#{uv_click},
		#{click_rate},
		#{avetime},
		#{bounce_rate},
		#{aveprice},
		#{telephone},
		#{eftelephone},
		#{weiliao},
		#{efweiliao},
		#{shangqiao},
		#{efshangqiao},
		#{message},
		#{dialogue_cost},
		#{efdialogue_cost},
		#{dialogue_time},
		#{screateDate},
		#{ecreateDate},
		#{create_date}


		)
	</insert>

</mapper>